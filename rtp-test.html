<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RTP Verification Test — Mystic Hunt</title>
  <style>
    :root {
      --bg: #05070e;
      --text: #f4f7ff;
      --good: #36d890;
      --warn: #f2cf6a;
      --bad: #ff5f7e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(180deg, #0a1024, #05070e);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      display: grid;
      place-items: center;
    }
    .container {
      max-width: 600px;
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.40);
      padding: 30px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
    }
    h1 {
      text-align: center;
      font-size: 28px;
      margin: 0 0 10px 0;
      font-weight: 900;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      letter-spacing: 1.4px;
      text-transform: uppercase;
      color: rgba(244,247,255,.55);
      margin: 0 0 30px 0;
    }
    .section {
      margin-bottom: 30px;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .section-title {
      font-size: 12px;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      color: rgba(242,207,106,.95);
      margin: 0 0 12px 0;
      font-weight: 900;
    }
    .control {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .control label {
      font-size: 12px;
      min-width: 80px;
    }
    .control input, .control select {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.30);
      color: var(--text);
      font: inherit;
      font-size: 12px;
    }
    .control input:focus, .control select:focus {
      outline: none;
      border-color: rgba(242,207,106,.55);
      background: rgba(0,0,0,.45);
    }
    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid rgba(242,207,106,.55);
      background: linear-gradient(180deg, rgba(242,207,106,.25), rgba(242,207,106,.10));
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      transition: all 160ms ease;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(180deg, rgba(242,207,106,.35), rgba(242,207,106,.18));
      border-color: rgba(242,207,106,.75);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .results {
      display: grid;
      gap: 12px;
    }
    .result-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
    }
    .result-label {
      font-size: 11px;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: rgba(244,247,255,.60);
    }
    .result-value {
      font-size: 16px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
      color: var(--text);
    }
    .result-row.pass .result-value {
      color: var(--good);
    }
    .result-row.warn .result-value {
      color: var(--warn);
    }
    .result-row.fail .result-value {
      color: var(--bad);
    }
    .status {
      font-size: 12px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      margin-top: 12px;
    }
    .status.running {
      background: rgba(242,207,106,.15);
      color: var(--warn);
      border: 1px solid rgba(242,207,106,.25);
    }
    .status.pass {
      background: rgba(54,216,144,.15);
      color: var(--good);
      border: 1px solid rgba(54,216,144,.25);
    }
    .status.fail {
      background: rgba(255,95,126,.15);
      color: var(--bad);
      border: 1px solid rgba(255,95,126,.25);
    }
    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(242,207,106,.25);
      border-top-color: rgba(242,207,106,.95);
      border-radius: 99px;
      animation: spin 0.9s linear infinite;
      margin-right: 8px;
      vertical-align: -2px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .info {
      font-size: 11px;
      color: rgba(244,247,255,.50);
      margin-top: 12px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>RTP Test</h1>
    <div class="subtitle">Monte Carlo Verification</div>

    <div class="section">
      <div class="section-title">Test Settings</div>
      <div class="control">
        <label for="trials">Trials:</label>
        <input type="number" id="trials" value="100000" min="1000" step="10000">
      </div>
      <div class="control">
        <label for="mode">Mode:</label>
        <select id="mode">
          <option value="normal">Normal</option>
          <option value="high">High</option>
          <option value="both">Both</option>
        </select>
      </div>
      <button id="runBtn" type="button">Run Test</button>
    </div>

    <div class="section">
      <div class="section-title">Results</div>
      <div class="results" id="results"></div>
      <div class="status" id="status" style="display:none;"></div>
    </div>

    <div class="info">
      <strong>About:</strong> This test runs a Monte Carlo simulation to verify empirical RTP matches the target (98%). Each trial draws a random card, prices the step at fixed RTP, and simulates a single hunt. Results within ±0.5% are considered passing.
    </div>
  </div>

  <script type="module">
    import { priceMultiplierScaled, MULT_SCALE, payoutFromScaled, TARGET_RTP } from './lib/gameEngine.js';
    import { deck } from './lib/deck.js';

    const runBtn = document.getElementById('runBtn');
    const trialsInput = document.getElementById('trials');
    const modeInput = document.getElementById('mode');
    const resultsDiv = document.getElementById('results');
    const statusDiv = document.getElementById('status');

    const TOLERANCE = 0.005; // 0.5%

    function formatPercent(x) {
      return (x * 100).toFixed(4) + '%';
    }

    async function runSimulation(mode, trials) {
      return new Promise((resolve) => {
        setTimeout(() => {
          let totalPayoutCents = 0;
          for (let i = 0; i < trials; i++) {
            const idx = Math.floor(Math.random() * deck.length);
            const c = deck[idx];
            const p = c[mode].p;
            const stepScaled = priceMultiplierScaled(p);
            const hit = Math.random() < p;
            if (hit) {
              totalPayoutCents += payoutFromScaled(100, stepScaled); // bet = 100 cents
            }
          }
          const empiricalRtp = totalPayoutCents / (trials * 100);
          resolve(empiricalRtp);
        }, 0);
      });
    }

    function createResultRow(label, value, pass) {
      const row = document.createElement('div');
      row.className = `result-row ${pass ? 'pass' : 'fail'}`;
      row.innerHTML = `
        <div class="result-label">${label}</div>
        <div class="result-value">${value}</div>
      `;
      return row;
    }

    async function runTest() {
      const trials = parseInt(trialsInput.value, 10);
      const mode = modeInput.value;

      if (!trials || trials < 1000) {
        alert('Trials must be at least 1000');
        return;
      }

      runBtn.disabled = true;
      resultsDiv.innerHTML = '';
      statusDiv.textContent = '';
      statusDiv.style.display = 'none';

      const statusMsg = statusDiv;
      statusMsg.innerHTML = '<span class="spinner"></span>Running...';
      statusMsg.className = 'status running';
      statusMsg.style.display = 'block';

      try {
        const modes = mode === 'both' ? ['normal', 'high'] : [mode];
        let allPass = true;

        for (const m of modes) {
          const empiricalRtp = await runSimulation(m, trials);
          const diff = Math.abs(empiricalRtp - TARGET_RTP);
          const pass = diff <= TOLERANCE;
          allPass = allPass && pass;

          resultsDiv.appendChild(
            createResultRow(
              `${m.toUpperCase()} empirical RTP`,
              formatPercent(empiricalRtp),
              pass
            )
          );
          resultsDiv.appendChild(
            createResultRow(
              `${m.toUpperCase()} diff from target`,
              formatPercent(diff),
              pass
            )
          );
        }

        resultsDiv.appendChild(
          createResultRow('Target RTP', formatPercent(TARGET_RTP), true)
        );
        resultsDiv.appendChild(
          createResultRow('Tolerance', formatPercent(TOLERANCE), true)
        );

        statusMsg.innerHTML = allPass
          ? '✓ PASS: Empirical RTP within tolerance'
          : '✗ FAIL: RTP outside tolerance';
        statusMsg.className = `status ${allPass ? 'pass' : 'fail'}`;
      } catch (err) {
        statusMsg.textContent = `Error: ${err.message}`;
        statusMsg.className = 'status fail';
        console.error(err);
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener('click', runTest);
  </script>
</body>
</html>
